---
title: "A3 report"
author: "Jonathan Stathakis"
date: "`r Sys.Date()`"
output: html_document
---

# A3 Report Workbook

## Import the data

```{r}
data <- read.csv('HbA1c2.csv')
head(data)
```

## Any missing values?

```{r}
library('tidyverse')
my_na <- data %>%
  is.na()
which(my_na)
```

There are no missing values for any variables within the dataset.

## Data Cleaning and Formatting

Sex, Group need to be converted to factors. Both consist of binary entries currently, both have two labels, no order required, but will input as per the data dictionary.

```{r}
proc_data <- data %>%
              mutate(Sex = 
                factor(
                  Sex, levels = c(0,1),
                  labels = c('Male','Female'))) %>%
              mutate(Group =
                       factor(
                         Group, levels = c(0,1),
                         labels = c('Control', 'Treatment'))) %>% print
```

To standardise Weight and Height across participants, they were combined into BMI, calculated as weight in kg divided by the square of the height in meters. BMI was then stratified into the following categories: Low $\leq$ 18.5, 18.5 \< Normal \< 25, 25 $\leq$ Overweight $\leq$ 29.9, Obese 30+. Participants were also divided into two Age groups, $55 \leq$ Age $\geq$ 56.

```{r}
proc_data <- proc_data %>%
              mutate(Age_cat = cut(Age,
                                breaks = c(-Inf, 55, Inf),
                                labels = c('0 - 55', '56+'),
                                ordered_result = TRUE)) %>%
              mutate(BMI = Weight/((Height/100)**2)) %>%
              mutate(BMI_cat = cut(BMI,
                                breaks = c(-Inf, 18.5, 25, 29.9, Inf),
                                labels = c('Low', 'Normal', 'Overweight', 'Obese'),
                                ordered_result = TRUE)) %>%
              print
```

Finally, a HbA1c measurement difference score was calculated as the difference between "HbA1c_Pre" and "HbA1c_Post", as we are expecting a decrease in measurements as a result of the treatment:

```{r}
proc_data <- proc_data %>%
              mutate(HbA1c_delta = HbA1c_Pre - HbA1c_Post) %>% print
```

## Table 1

To calculate CI:

```{r}
CI_calc <- function(mean) {
  error <- qnorm(0.975)*s/sqrt(n)
  left <- a-error
  right <- a+error
  return(c(left, right))
}
```

## HbA1c_delta Table

```{r}
mean_table = proc_data %>%
  summarize(across(c(Age, Height, Weight, BMI_cat, HbA1c_Pre, HbA1c_Post,  HbA1c_delta),
                   mean, .names = '{.col}')) %>% 
  pivot_longer(
    everything(),
    names_to = 'Variable',
    values_to = 'mean' 
    )

sd_table = proc_data %>%
  summarize(across(c(Age, Height, Weight, BMI, HbA1c_Pre, HbA1c_Post,  HbA1c_delta),
                   sd, .names = '{.col}')) %>%
  pivot_longer(
    everything(),
    names_to = 'Variable',
    values_to = 'sd'
  ) 

CI_lower_table = proc_data %>%
  summarize(across(c(Age, Height, Weight, BMI, HbA1c_Pre, HbA1c_Post,  HbA1c_delta),
                   CI_lower_calc, .names = '{.col}')) %>%
  pivot_longer(
    everything(),
    names_to = 'Variable',
    values_to = 'CI_lower'
  ) 

CI_upper_table = proc_data %>%
  summarize(across(c(Age, Height, Weight, BMI, HbA1c_Pre, HbA1c_Post,  HbA1c_delta),
                   CI_upper_calc, .names = '{.col}')) %>%
  pivot_longer(
    everything(),
    names_to = 'Variable',
    values_to = 'CI_upper'
  ) 

library(gt)

num_vars = left_join(mean_table, sd_table) %>%
    left_join(CI_lower_table) %>%
      left_join(CI_upper_table)

num_vars %>% 
  mutate(Variable = c('Age (years)', 'Height (cm)', 'Weight (kg)', 'BMI (kg/m^2)', 'HbA1c_Pre', 'HbA1c_Post', 'HbA1c_Delta')) %>%
  gt() %>%
    tab_header(
    title = md('## Numerical Variables')
  ) %>% 
  fmt_number(
    columns = 2,
    rows = everything(),
    decimals = 1) %>%
      fmt_number(
        columns = 3:5,
        decimals = 2
      ) %>% 
  cols_label(
    Variable = md("#### Variable"),
    mean = md("#### Mean"),
    sd = md("#### SD"),
    CI_lower = md('#### CI Lower'),
    CI_upper = md('#### CI Upper')
  )%>% print

```
