---
title: "HbA1c epidata A3"
output: powerpoint_presentation
author: "Jonathan Stathakis"
---

```{r}
library('tidyverse')
```

```{r}
data <- read.csv("HbA1c2.csv")
head(data)
```

1.  identify missing values
2.  Identify and convert categorical vs. numerical variables.

non-numeric variable: patient ID. Numeric variables - Age, Height, Weight, HbA1c_Pre, HbA1c_Post. Categorical variables - Sex, Group

```{r}
dim(data)
```

1234 instances, 8 variables including ID.

```{r}
my_na <- data %>%  
          is.na()
which(my_na)
```

No missing values.

## Workup

Sex, Group need to be converted to factors. Both consist of binary entries currently, both have two labels, no order required, but will input as per the data dictionary.

2.  BMI calculated as weight / (height / 100)\^2

3.  BMI in categories Low *\<18.5, Normal 18.5 \< x \< 25, Overweight 25* \< x \_\< 29.9, obese 30+

```{r}
rm(list=ls())
data <- read.csv("HbA1c2.csv")

proc_data <- data %>%
              mutate(Sex = factor(Sex, levels = c(0,1), labels = c('Female', 'Male'))) %>% 
              mutate(Group = factor(Group, levels = c(0,1), labels = c('Control', 'Treatment')))%>%

  mutate(Age_cat = cut(Age,
                breaks = c(-Inf, 55, Inf),
                labels = c('0 - 55', '56+'),
                ordered_result = TRUE)) %>%
  mutate(BMI = Weight/((Height/100)**2)
          ) %>%
  mutate(HbA1c_delta = HbA1c_Pre - HbA1c_Post) %>%
  mutate(BMI_cat = cut(BMI,
            breaks = c(-Inf, 18.5, 25, 29.9, Inf),
            labels = c('Low', 'Normal', 'Overweight', 'Obese'),
            ordered_result = TRUE)
        ) %>%
  print
```

## Analysis

```{r}
#rm(list=ls())
av_BMI_Group_treat_diff = proc_data %>%
  group_by(BMI_cat, Group) %>%
  summarise(av_treat_diff = mean(HbA1c_delta))

ggplot(av_BMI_Group_treat_diff, aes(BMI_cat, 
                                    av_treat_diff,
                                    fill = Group))+ 
  geom_bar(stat = "identity",
           position='dodge')
```

For males:

```{r}
male_data = proc_data %>% 
  filter(Sex == 'Male') %>%
  group_by(BMI_cat, Group) %>%
  summarise(av_treat_diff = mean(HbA1c_delta))

ggplot(male_data, aes(BMI_cat, 
                                    av_treat_diff,
                                    fill = Group))+ 
  geom_bar(stat = "identity",
           position='dodge')
```

For females:

```{r}
data_Group_BMI = proc_data %>% 
  filter(Sex == 'Female') %>%
  summarise(av_treat_diff = mean(HbA1c_delta))

# ggplot(female_data, aes(BMI_cat, 
#                                     av_treat_diff,
#                                     fill = Group)) + 
#   geom_bar(stat = "identity",
#            position='dodge')
```

It appears that males are all categorized as Overweight or Obese BMI, females as normal, Overweight, and Obese.

Not important right now. What is important is generating presentable statistics.

What are the statistics to get?

mean, sd, CI.

```{r}
?group_by
```

```{r}
proc_data %>% 
  names
```

```{r}
data_stats  = proc_data %>%
  group_by(BMI_cat, Sex, Age, Group) %>%
  summarize(diff_mean = mean(HbA1c_delta), diff_sd = sd(HbA1c_delta)) %>% print

  ggplot(data_stats, aes(BMI_cat, diff_mean, fill = Group ))+
   geom_bar(stat = "identity",
           position='dodge') + 
    scale_fill_manual(values = c('#009E73','#E69F00'))

#barplot(data_stats$mean)
?geom_bar
```

link to color maps: [http://www.cookbook-r.com/Graphs/Colors\_(ggplot2)/](http://www.cookbook-r.com/Graphs/Colors_(ggplot2)/)

## Table

Using table_by function.

```{r}
library(qwraps2)
?qsummary
```

```{r}
new_summary <- 
  qsummary(proc_data[, c()],
           )
```

Found the perfect example: <http://rstudio-pubs-static.s3.amazonaws.com/143812_0a4447ca4da14ee3a8ece4d6af43d896.html>

tables: <https://www.danieldsjoberg.com/gtsummary/>

<https://gt.rstudio.com/>

```{r}
library(gtable)
```

## Statistics

```{r}
CI_calc <- function(mean) {
  error <- qnorm(0.975)*s/sqrt(n)
  left <- a-error
  right <- a+error
  return(left, right)
}
```

## OOP approach to descriptive statistics

```{r}


group_by = c(proc_data$BMI_cat)
filter = c("Male")

stats = proc_data %>%
  filter(Sex == 'Male', Age == '56+', Group == 'Treatment', BMI_cat == 'Obese') %>%
  select(HbA1c_delta) %>%
  summarize(mean = mean(HbA1c_delta),
            error = abs(qnorm((0.05)/2))* sd(HbA1c_delta)/sqrt(n()),
            CI_lower = mean - error,
            CI_upper = mean + error
            ) %>% print

```

CI calc taken from here <https://www.r-bloggers.com/2021/04/calculating-confidence-interval-in-r/>

I am trying to create an iterable function to generate the statistics for every subpopulation.

Subpopulations: Male, Female, BMI_lower, BMI_normal, BMI_overweight, BMI_obese, Age *\<55, Age*\_56+,

```{r}
## Note: an attempt to OOP the summary statistics pipeline. Became too difficult when I realised that to iterate over every subpop I would need to input multidimensional arrays of strings. Decided to brute force it. 
# sum_stats <- 
#   function(.data){
#   if (dplyr::is_grouped_df(.data)){
#     return(dplyr::do(.data, sum_stats(.)))
#   }
#   summarize(mean = mean(.data),
#             error = abs(qnorm((0.05)/2))* sd(.data)/sqrt(n()),
#             CI_lower = mean - error,
#             CI_upper = mean + error)
#   .data
#   }
# 
# stats = proc_data %>%
#   filter(Sex == 'Male', Age == '56+', Group == 'Treatment', BMI_cat == 'Obese') %>%
#   select(HbA1c_delta) %>%
#   sum_stats %>% print
  
```

custom functions synergizing with pipes: <https://www.r-bloggers.com/2018/07/writing-pipe-friendly-functions/>

```{r}
## an example of creating custom functions for pipes, 
# df = data.frame(col1 = c('a','a','b'),col2 = c(9,9,9))
# print(df)
# 
# test_func <- 
#   ## need this line in custom functions to enable grouping
#   function(.data){
#   if (dplyr::is_grouped_df(.data)){
#     return(dplyr::do(.data, test_func(.)))
#   }
#   mutate(mean = mean())
#   print(.data)
#   #mutate(mean(.data[var]))
#   .data
# }
# 
# df %>% 
#   filter(col1 == 'a') %>%
#   test_func %>% print
```

Subpopulations: Male, Female, BMI_lower, BMI_normal, BMI_overweight, BMI_obese, Age *\<55, Age*\_56+.

I am going to create a df for each subpop then bindrows to create a table.

```{r}
## Descriptive Statistics Table
Sex_Male = proc_data %>%
  filter(Sex == 'Male') %>%
  select(HbA1c_delta) %>%
  summarize(mean = mean(HbA1c_delta),
            sd = sd(HbA1c_delta),
            error = abs(qnorm((0.05)/2))* sd(HbA1c_delta)/sqrt(n()),
            CI_lower = (mean - error),
            CI_upper = (mean + error)
            )

Sex_Female = proc_data %>%
  filter(Sex == 'Female') %>%
  select(HbA1c_delta) %>%
    summarize(mean = mean(HbA1c_delta),
            sd = sd(HbA1c_delta),
            error = abs(qnorm((0.05)/2))* sd(HbA1c_delta)/sqrt(n()),
            CI_lower = (mean - error),
            CI_upper = (mean + error)
            )

BMI_normal = proc_data %>%
  filter(BMI_cat == 'Normal') %>%
  select(HbA1c_delta) %>%
   summarize(mean = mean(HbA1c_delta),
            sd = sd(HbA1c_delta),
            error = abs(qnorm((0.05)/2))* sd(HbA1c_delta)/sqrt(n()),
            CI_lower = (mean - error),
            CI_upper = (mean + error)
            ) 

BMI_overweight = proc_data %>%
  filter(BMI_cat == 'Overweight') %>%
  select(HbA1c_delta) %>%
    summarize(mean = mean(HbA1c_delta),
            sd = sd(HbA1c_delta),
            error = abs(qnorm((0.05)/2))* sd(HbA1c_delta)/sqrt(n()),
            CI_lower = (mean - error),
            CI_upper = (mean + error)
            ) 
BMI_obese = proc_data %>%
  filter(BMI_cat == 'Obese') %>%
  select(HbA1c_delta) %>%
    summarize(mean = mean(HbA1c_delta),
            sd = sd(HbA1c_delta),
            error = abs(qnorm((0.05)/2))* sd(HbA1c_delta)/sqrt(n()),
            CI_lower = (mean - error),
            CI_upper = (mean + error)
            ) 

Age_55 = proc_data %>%
  filter(Age == '0 - 55') %>%
  select(HbA1c_delta) %>%
    summarize(mean = mean(HbA1c_delta),
            sd = sd(HbA1c_delta),
            error = abs(qnorm((0.05)/2))* sd(HbA1c_delta)/sqrt(n()),
            CI_lower = (mean - error),
            CI_upper = (mean + error)
            )

Age_56 = proc_data %>%
  filter(Age == '56+') %>%
  select(HbA1c_delta) %>%
   summarize(mean = mean(HbA1c_delta),
            sd = sd(HbA1c_delta),
            error = abs(qnorm((0.05)/2))* sd(HbA1c_delta)/sqrt(n()),
            CI_lower = (mean - error),
            CI_upper = (mean + error)
            )

# Binding the rows together
stats_df = bind_rows(Sex_Female, Sex_Male, BMI_normal, BMI_overweight, BMI_obese, Age_55, Age_56, .id = NULL)

# Adding an identifying column. 
subpop_names = c('Sex_Female', 'Sex_Male','BMI_normal', 'BMI_Overweight', 'BMI_Obese', 'Age_0-55', 'Age_56+')

stat_df = bind_rows(Sex_Female, Sex_Male, BMI_normal, BMI_overweight, BMI_obese, Age_55, Age_56)

stat_df = bind_cols('subpops' =subpop_names, stat_df)

```

```{r}
# Plotitng

group_bplot = proc_data %>%
  #filter(Group == 'Control') %>%
  ggplot(aes(BMI_cat, HbA1c_delta, fill = Age))+
    geom_boxplot()+
    scale_fill_manual(values = c('#009E73','#E69F00')) +
  facet_wrap(~Group, scale='fixed') 

gender_bplot = proc_data %>%
  #filter(Group == 'Control') %>%
  ggplot(aes(BMI_cat, HbA1c_delta, fill = Age))+
    geom_boxplot()+
    scale_fill_manual(values = c('#009E73','#E69F00')) +
  facet_wrap(~Sex, scale = 'fixed', )

group_bplot
gender_bplot

```

```{r}
names(proc_data)
```

# Generating Num and Cat Tables

```{r}
CI_lower_calc <- function(data) {
  mean = mean(data)

  error = abs(qnorm((0.05)/2))* sd(data)/sqrt(n())
  CI_lower = (mean - error)
  return(CI_lower)
}

CI_upper_calc <- function(data) {
  mean = mean(data)

  error = abs(qnorm((0.05)/2))* sd(data)/sqrt(n())
  CI_upper = (mean + error)
  return(CI_upper)
}


mean_table = proc_data %>%
  summarize(across(c(Age, Height, Weight, BMI, HbA1c_Pre, HbA1c_Post,  HbA1c_delta),
                   mean, .names = '{.col}')) %>% 
  pivot_longer(
    everything(),
    names_to = 'Variable',
    values_to = 'mean' 
    )

sd_table = proc_data %>%
  summarize(across(c(Age, Height, Weight, BMI, HbA1c_Pre, HbA1c_Post,  HbA1c_delta),
                   sd, .names = '{.col}')) %>%
  pivot_longer(
    everything(),
    names_to = 'Variable',
    values_to = 'sd'
  ) 

CI_lower_table = proc_data %>%
  summarize(across(c(Age, Height, Weight, BMI, HbA1c_Pre, HbA1c_Post,  HbA1c_delta),
                   CI_calc, .names = '{.col}')) %>%
  pivot_longer(
    everything(),
    names_to = 'Variable',
    values_to = 'CI lower'
  ) 

CI_upper_table = proc_data %>%
  summarize(across(c(Age, Height, Weight, BMI, HbA1c_Pre, HbA1c_Post,  HbA1c_delta),
                   CI_upper_calc, .names = '{.col}')) %>%
  pivot_longer(
    everything(),
    names_to = 'Variable',
    values_to = 'CI upper'
  ) 

 num_vars = left_join(mean_table, sd_table) %>%
    left_join(CI_lower_table) %>%
      left_join(CI_upper_table) %>% print
?left_join
```

```{r}

names(proc_data)

Age_cat_stats = proc_data %>%
    group_by(Age_cat) %>%
      summarize(Abs.Freq = n()) %>% 
      mutate(Cumsum.Abs.Freq = cumsum(Abs.Freq)) %>%
      mutate(Rel.Freq = Abs.Freq / sum(Abs.Freq)) %>%
      mutate(Cumsum.Rel.Freq = cumsum(Rel.Freq)) %>%
print

BMI_cat_stats = proc_data %>%
    group_by(BMI_cat) %>%
      summarize(Abs.Freq = n()) %>% 
      mutate(Cumsum.Abs.Freq = cumsum(Abs.Freq)) %>%
      mutate(Rel.Freq = Abs.Freq / sum(Abs.Freq)) %>%
      mutate(Cumsum.Rel.Freq = cumsum(Rel.Freq)) %>%
print
```

```{r}
library(gt)
gt_tbl <- gt(BMI_cat_stats) %>% print
```
